local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- DELETE BOATS DEALERSHIP FOLDER IMMEDIATELY
local success, err = pcall(function()
    local boatsFolder = game:GetService("Workspace").Game.Dealerships.Dealerships:FindFirstChild("Boats")
    if boatsFolder then
        boatsFolder:Destroy()
        print("Boats folder deleted successfully!")
    end
end)

-- HANDLE LOADING UI - Auto-click Play button, look down, and close Navigation UI
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local GuiService = game:GetService("GuiService")

local function handleLoadingUI()
    task.spawn(function()
        -- Wait for LoadingUI to exist
        local playerGui = player:WaitForChild("PlayerGui")
        local loadingUI = playerGui:WaitForChild("LoadingUI", 10)
        
        if loadingUI then
            local playButton = loadingUI:FindFirstChild("Menu")
            if playButton then
                playButton = playButton:FindFirstChild("Main")
                if playButton then
                    playButton = playButton:FindFirstChild("Play")
                    
                    if playButton and playButton:IsA("GuiButton") then
                        -- Use GuiService to select the button
                        GuiService.SelectedObject = playButton
                        task.wait(0.2)
                        
                        -- Press Enter to activate it
                        local VIM = game:GetService("VirtualInputManager")
                        VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                        task.wait(0.1)
                        VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                        
                        print("Play button clicked!")
                        
                        -- Wait 3 seconds
                        task.wait(3)
                        
                        -- Make character look down
                        local character = player.Character or player.CharacterAdded:Wait()
                        local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
                        local camera = workspace.CurrentCamera
                        
                        -- Set camera to look down
                        camera.CameraType = Enum.CameraType.Scriptable
                        camera.CFrame = CFrame.new(humanoidRootPart.Position + Vector3.new(0, 5, 0), humanoidRootPart.Position - Vector3.new(0, 10, 0))
                        
                        task.wait(0.5)
                        
                        -- Reset camera back to player control
                        camera.CameraType = Enum.CameraType.Custom
                        
                        print("Character looking down, ready for autofarming!")
                        
                        -- CLOSE NAVIGATION UI - Multiple attempts with different methods
                        task.wait(2) -- Wait longer for Navigation UI to fully appear
                        
                        local navigationUI = playerGui:FindFirstChild("NavigationUI")
                        if navigationUI then
                            print("Found NavigationUI, attempting to close...")
                            
                            -- Method 1: Try to find and click close button
                            local function findAndClickClose()
                                -- Search recursively for close button
                                for _, descendant in pairs(navigationUI:GetDescendants()) do
                                    if descendant:IsA("GuiButton") then
                                        local name = descendant.Name:lower()
                                        if name:find("close") or name:find("x") or name:find("exit") then
                                            print("Found close button:", descendant.Name)
                                            GuiService.SelectedObject = descendant
                                            task.wait(0.1)
                                            VIM:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                                            task.wait(0.1)
                                            VIM:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                                            return true
                                        end
                                    end
                                end
                                return false
                            end
                            
                            local closed = findAndClickClose()
                            
                            if closed then
                                print("Navigation UI closed via button!")
                            else
                                -- Method 2: Just disable it directly
                                navigationUI.Enabled = false
                                print("Navigation UI disabled directly!")
                            end
                            
                            -- Method 3: Destroy it as backup (aggressive)
                            task.wait(0.5)
                            if navigationUI and navigationUI.Parent then
                                navigationUI:Destroy()
                                print("Navigation UI destroyed!")
                            end
                        else
                            print("NavigationUI not found")
                        end
                    end
                end
            end
        end
    end)
end

-- Start the loading UI handler
handleLoadingUI()

-- AUTO-EXECUTE ON SERVER JOIN (for Xeno Executor)
-- This will automatically run when you join a new server
player.OnTeleport:Connect(function(State)
    if State == Enum.TeleportState.Started then
        print("Teleporting to new server...")
        -- Queue the script to run again after teleport
        queue_on_teleport([[
            repeat task.wait() until game:IsLoaded()
            loadstring(game:HttpGet('YOUR_SCRIPT_URL_HERE'))()
        ]])
    end
end)

local Window = Rayfield:CreateWindow({
   Name = "Rafso Driving Empire",
   LoadingTitle = "Enjoy it.",
   LoadingSubtitle = "by Rafso",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Autofarm"
   },
   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },
   KeySystem = false,
})

local MainTab = Window:CreateTab("Main", 4483362458)

local Workspace = game:GetService("Workspace")
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- Sell timer variables
local lastSellTime = tick()
local sellInterval = 600 -- 10 minutes in seconds
local sellLocation = Vector3.new(-2544, 26, 4030) -- Sell location coordinate

-- Death detection and restart
local function setupDeathDetection()
    humanoid.Died:Connect(function()
        StatusLabel:Set("Status: Character died! Waiting to respawn...")
        
        -- Wait for respawn
        character = player.Character or player.CharacterAdded:Wait()
        humanoidRootPart = character:WaitForChild("HumanoidRootPart")
        humanoid = character:WaitForChild("Humanoid")
        
        -- Disable any lingering float
        disableFloat()
        
        -- Wait a moment for character to stabilize
        task.wait(2)
        
        StatusLabel:Set("Status: Respawned! Restarting from ATM 1...")
        
        -- Restart the script if still enabled
        if autoATMEnabled then
            isRunning = false
            task.wait(0.5)
            task.spawn(runAutoATM)
        end
    end)
end

-- Function to get all handle tools
local function GetHandleTools(p)
    p = p or player
    local r = {}
    for _, v in ipairs(p.Character and p.Character:GetChildren() or {}) do
        if v:IsA("BackpackItem") and v:FindFirstChild("Handle") then
            r[#r + 1] = v
        end
    end
    for _, v in ipairs(p.Backpack:GetChildren()) do
        if v:IsA("BackpackItem") and v:FindFirstChild("Handle") then
            r[#r + 1] = v
        end
    end
    return r
end

-- DEDICATED UNEQUIP LOOP - RUNS CONSTANTLY
local unequipLoopRunning = false
local function startUnequipLoop()
    unequipLoopRunning = true
    
    task.spawn(function()
        while unequipLoopRunning and autoATMEnabled do
            -- Get current character EVERY LOOP
            local char = player.Character
            if char then
                local hum = char:FindFirstChildOfClass('Humanoid')
                if hum then
                    pcall(function()
                        hum:UnequipTools()
                    end)
                end
                
                -- Also delete CriminalMoneyBag
                for _, item in pairs(char:GetChildren()) do
                    if item.Name == "CriminalMoneyBag" then
                        pcall(function()
                            item:Destroy()
                        end)
                    end
                end
            end
            
            task.wait(0.01) -- Loop every 0.01 seconds - SUPER FAST
        end
    end)
end

local function stopUnequipLoop()
    unequipLoopRunning = false
end

-- Function to setup auto-unequip monitoring
local autoUnequipHeartbeat = nil
local function setupAutoUnequip()
    -- Disconnect old connection if exists
    if autoUnequipHeartbeat then
        autoUnequipHeartbeat:Disconnect()
    end
    
    -- Start the dedicated unequip loop
    startUnequipLoop()
    
    -- Check EVERY FRAME and force unequip
    autoUnequipHeartbeat = game:GetService("RunService").Heartbeat:Connect(function()
        if autoATMEnabled then
            -- Get current character
            local char = player.Character
            if not char then return end
            
            local hum = char:FindFirstChildOfClass('Humanoid')
            if hum then
                pcall(function()
                    hum:UnequipTools()
                end)
            end
            
            -- DELETE CriminalMoneyBag
            for _, item in pairs(char:GetChildren()) do
                if item.Name == "CriminalMoneyBag" then
                    pcall(function()
                        item:Destroy()
                    end)
                end
            end
        end
    end)
end

-- Function to disable auto-unequip
local function disableAutoUnequip()
    stopUnequipLoop()
    if autoUnequipHeartbeat then
        autoUnequipHeartbeat:Disconnect()
        autoUnequipHeartbeat = nil
    end
end

-- ATM Coordinates (all 48 locations)
local atmCoordinates = {
    Vector3.new(-1053.50, 9.10, 5045.60),
    Vector3.new(-1696.70, 12.30, 4920.00),
    Vector3.new(-1346.90, 11.80, 4332.50),
    Vector3.new(-1892.30, 12.50, 4862.80),
    Vector3.new(-2172.50, 11.90, 4740.90),
    Vector3.new(-2225.50, 12.40, 4091.50),
    Vector3.new(-859.40, 12.40, 3780.80),
    Vector3.new(-1206.80, 12.40, 3699.00),
    Vector3.new(-2085.00, 12.40, 3411.30),
    Vector3.new(-2043.80, 12.40, 3223.40),
    Vector3.new(-2081.50, 12.40, 2822.90),
    Vector3.new(-1992.80, 12.40, 2693.80),
    Vector3.new(-1894.20, 12.40, 2706.20),
    Vector3.new(-1600.80, 11.80, 2804.30),
    Vector3.new(-2556.30, 27.60, 2477.20),
    Vector3.new(-1415.00, 11.60, 2840.70),
    Vector3.new(-1681.80, 12.50, 1773.50),
    Vector3.new(-1249.60, 12.50, 2329.80),
    Vector3.new(-1201.10, 13.20, 2548.10),
    Vector3.new(-1129.90, 12.40, 3246.60),
    Vector3.new(-815.80, 12.50, 3097.10),
    Vector3.new(-356.30, 12.40, 3194.30),
    Vector3.new(-461.40, 12.40, 3672.60),
    Vector3.new(145.60, 12.20, 3658.00),
    Vector3.new(134.10, 26.60, 2186.60),
    Vector3.new(992.40, 33.10, 1796.10),
    Vector3.new(595.90, 33.10, 1622.70),
    Vector3.new(237.10, 9.50, 815.90),
    Vector3.new(269.30, 33.00, 478.40),
    Vector3.new(-372.70, 23.70, 63.70),
    Vector3.new(-611.40, 23.70, -31.70),
    Vector3.new(-271.80, 23.70, -235.40),
    Vector3.new(-97.70, 23.60, -108.00),
    Vector3.new(-524.80, 24.70, -432.00),
    Vector3.new(-251.60, 24.70, -475.50),
    Vector3.new(-976.20, 23.50, -585.40),
    Vector3.new(-631.20, 23.00, -727.10),
    Vector3.new(-1203.20, 23.50, -1144.20),
    Vector3.new(-1115.20, 23.50, -833.90),
    Vector3.new(-576.20, 23.50, -972.90),
    Vector3.new(93.00, 23.70, -984.10),
    Vector3.new(195.20, 33.00, -15.70),
    Vector3.new(399.00, 23.70, -978.10),
    Vector3.new(591.90, 33.00, 189.40),
    Vector3.new(886.70, 33.00, -86.30),
    Vector3.new(881.60, 33.00, 187.80),
    Vector3.new(-374.70, 14.70, -1815.50),
    Vector3.new(-967.40, 23.60, -1730.40)
}

-- Variables
local autoATMEnabled = false
local isRunning = false
local atmProcessed = 0
local atmSkipped = 0

-- Status Label
local StatusLabel = MainTab:CreateLabel("Status: Idle")
local ProgressLabel = MainTab:CreateLabel("Progress: 0/48 ATMs processed")
local SellTimerLabel = MainTab:CreateLabel("Next Sell: 10:00")

-- Function to update sell timer display
local function updateSellTimer()
    task.spawn(function()
        while autoATMEnabled do
            local timeElapsed = tick() - lastSellTime
            local timeRemaining = sellInterval - timeElapsed
            
            if timeRemaining > 0 then
                local minutes = math.floor(timeRemaining / 60)
                local seconds = math.floor(timeRemaining % 60)
                SellTimerLabel:Set(string.format("Next Sell: %02d:%02d", minutes, seconds))
            else
                SellTimerLabel:Set("Next Sell: READY")
            end
            
            task.wait(1)
        end
        SellTimerLabel:Set("Next Sell: --:--")
    end)
end

-- Function to freeze character
local function freezeCharacter(freeze)
    if character and humanoidRootPart then
        humanoidRootPart.Anchored = freeze
        if freeze then
            humanoid.WalkSpeed = 0
            humanoid.JumpPower = 0
        else
            humanoid.WalkSpeed = 16
            humanoid.JumpPower = 50
        end
    end
end

-- Function to completely unfreeze character (with physics reset)
local function completelyUnfreezeCharacter()
    -- Unfreeze all body parts
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.Anchored = false
            part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
            part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
        end
    end
    
    -- Reset humanoid properties
    humanoid.WalkSpeed = 16
    humanoid.JumpPower = 50
    humanoid.AutoRotate = true
    humanoid.Sit = false
    
    -- Make sure HumanoidRootPart is unfrozen
    humanoidRootPart.Anchored = false
    humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
    humanoidRootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    
    -- Small wait to let physics settle
    task.wait(0.1)
end

-- Function to teleport properly
local function properTeleport(targetPos)
    -- Teleport character
    humanoidRootPart.CFrame = CFrame.new(targetPos)
    
    -- Reset all velocities to prevent physics issues
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
            part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
        end
    end
    
    -- Small wait to stabilize
    task.wait(0.05)
end

-- Function to enable floating (zero gravity)
local floatBodyVelocity = nil
local function enableFloat()
    -- Remove old float if exists
    if floatBodyVelocity then
        floatBodyVelocity:Destroy()
    end
    
    -- Create BodyVelocity for zero gravity floating
    floatBodyVelocity = Instance.new("BodyVelocity")
    floatBodyVelocity.MaxForce = Vector3.new(0, math.huge, 0) -- Only affect Y axis
    floatBodyVelocity.Velocity = Vector3.new(0, 0, 0) -- No movement
    floatBodyVelocity.Parent = humanoidRootPart
    
    -- Disable humanoid gravity
    humanoid.PlatformStand = true
end

-- Function to disable floating
local function disableFloat()
    if floatBodyVelocity then
        floatBodyVelocity:Destroy()
        floatBodyVelocity = nil
    end
    
    -- Re-enable humanoid gravity
    humanoid.PlatformStand = false
end

-- Safe spot coordinate
local safeTeleportSpot = Vector3.new(-773, 99999, -1283)

-- Function to find closest ATM spawner to coordinate
local function findATMSpawnerAtCoordinate(targetPos)
    local spawners = Workspace.Game.Jobs.CriminalATMSpawners:GetChildren()
    local closestSpawner = nil
    local closestDistance = math.huge
    
    for _, spawner in pairs(spawners) do
        if spawner.Name == "CriminalATMSpawner" then
            local spawnerPos = spawner:IsA("Model") and spawner:GetPivot().Position or spawner.Position
            local distance = (spawnerPos - targetPos).Magnitude
            
            if distance < closestDistance and distance < 50 then -- Within 50 studs
                closestDistance = distance
                closestSpawner = spawner
            end
        end
    end
    
    return closestSpawner
end

-- Function to check if ATM has enabled ProximityPrompt
local function checkATMPrompt(spawner)
    local criminalATM = spawner:FindFirstChild("CriminalATM")
    if not criminalATM then
        return nil
    end
    
    local attachment = criminalATM:FindFirstChild("Attachment")
    if not attachment then
        return nil
    end
    
    local proximityPrompt = attachment:FindFirstChild("ProximityPrompt")
    if proximityPrompt and proximityPrompt.Enabled then
        return proximityPrompt
    end
    
    return nil
end

-- SELL FUNCTION - Completely stops ATM farming and sells
local function performSell()
    StatusLabel:Set("Status: â° TIME TO SELL! Stopping all ATM farming...")
    
    -- Completely unfreeze character and disable float
    completelyUnfreezeCharacter()
    disableFloat()
    
    -- Teleport to sell location 3 times with 1 second delay
    for i = 1, 3 do
        StatusLabel:Set(string.format("Status: ðŸ’° SELLING - Teleport %d/3 to sell location...", i))
        properTeleport(sellLocation)
        task.wait(1) -- 1 second delay between each teleport
    end
    
    -- After 3 teleports, wait a bit and update status
    StatusLabel:Set("Status: âœ… Sell complete! Resuming ATM farming in 3 seconds...")
    task.wait(3)
    
    -- Reset the sell timer
    lastSellTime = tick()
    
    StatusLabel:Set("Status: ðŸ”„ Resuming ATM farming...")
end

-- Main Autofarm Function
local function runAutoATM()
    if isRunning then return end
    isRunning = true
    
    -- Reset sell timer on start
    lastSellTime = tick()
    
    -- Setup death detection
    setupDeathDetection()
    
    -- Setup aggressive auto-unequip monitoring
    setupAutoUnequip()
    
    -- Start sell timer display
    updateSellTimer()
    
    -- Loop infinitely for overnight farming
    while autoATMEnabled do
        atmProcessed = 0
        atmSkipped = 0
        
        StatusLabel:Set("Status: Starting Autofarm run...")
        
        -- Loop through all ATMs ONCE before going to drop-off
        for cycle = 1, 1 do
            StatusLabel:Set(string.format("Status: Starting ATM run...", cycle))
            
            for i, coord in ipairs(atmCoordinates) do
                if not autoATMEnabled then
                    StatusLabel:Set("Status: Stopped by user")
                    break
                end
            
            -- CHECK IF IT'S TIME TO SELL (every 10 minutes)
            local currentTime = tick()
            if (currentTime - lastSellTime) >= sellInterval then
                performSell() -- This will COMPLETELY STOP and teleport 3 times to sell
            end
            
            StatusLabel:Set(string.format("Status: Checking ATM %d/48...", i))
            ProgressLabel:Set(string.format("Progress: %d/48 | Processed: %d | Skipped: %d", i, atmProcessed, atmSkipped))
            
            -- Teleport to ATM location (slightly above to prevent ground clipping)
            StatusLabel:Set(string.format("Status: ATM %d - Teleporting to location...", i))
            local safeCoord = coord + Vector3.new(0, 3, 0) -- 3 studs above to be safe
            properTeleport(safeCoord)
            
            task.wait(0.1) -- Wait time to stabilize and prevent death
            
            -- Quick check: Find the spawner at this location
            local spawner = findATMSpawnerAtCoordinate(coord)
            
            if not spawner then
                StatusLabel:Set(string.format("Status: ATM %d - No spawner, skipping fast...", i))
                atmSkipped = atmSkipped + 1
                continue
            end
            
            -- Quick check: Does it have CriminalATM model?
            local criminalATM = spawner:FindFirstChild("CriminalATM")
            if not criminalATM then
                StatusLabel:Set(string.format("Status: ATM %d - No ATM model, skipping fast...", i))
                atmSkipped = atmSkipped + 1
                continue
            end
            
            -- Check if ATM has enabled ProximityPrompt
            local prompt = checkATMPrompt(spawner)
            
            if not prompt then
                StatusLabel:Set(string.format("Status: ATM %d - No enabled prompt, skipping fast...", i))
                atmSkipped = atmSkipped + 1
                continue
            end
            
            -- Valid ATM found! Freeze for 0.2 seconds first
            StatusLabel:Set(string.format("Status: ATM %d - Valid ATM found! Freezing...", i))
            
            -- Freeze character at teleport position
            freezeCharacter(true)
            
            -- Wait 0.2 seconds while frozen
            task.wait(0.2)
            
            -- Now unfreeze character
            StatusLabel:Set(string.format("Status: ATM %d - Unfreezing and interacting...", i))
            completelyUnfreezeCharacter()
            
            -- Wait 0.1 seconds after unfreezing before triggering
            task.wait(0.1)
            
            -- Get hold duration
            local holdDuration = prompt.HoldDuration or 1
            
            -- Hold the prompt using VirtualInputManager
            StatusLabel:Set(string.format("Status: ATM %d - Holding prompt for %.1fs...", i, holdDuration))
            
            local VIM = game:GetService("VirtualInputManager")
            
            -- Press and hold E key
            VIM:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            
            -- Hold for the full duration without any interruption
            task.wait(holdDuration + 0.5) -- Increased buffer back to 0.5
            
            -- Release E key
            VIM:SendKeyEvent(false, Enum.KeyCode.E, false, game)
            
            atmProcessed = atmProcessed + 1
            
            -- Disable float before teleporting to safe spot
            disableFloat()
            
            -- Completely unfreeze character
            completelyUnfreezeCharacter()
            
            -- Wait 1 second before teleporting to safe zone
            task.wait(0.1)
            
            -- Check if still enabled before teleporting to safe spot
            if not autoATMEnabled then
                StatusLabel:Set("Status: Autofarm stopped by user")
                break
            end
            
            StatusLabel:Set(string.format("Status: ATM %d - Complete! Teleporting to safe spot...", i))
            
            -- Teleport to safe spot and wait 3 seconds
            properTeleport(safeTeleportSpot)
            
            -- Check again after teleport
            if not autoATMEnabled then
                StatusLabel:Set("Status: Autofarm stopped by user")
                break
            end
            
            task.wait(5)
            
            -- Add extra wait before next ATM to prevent death
            StatusLabel:Set(string.format("Status: ATM %d - Waiting before next ATM...", i))
            task.wait(0) -- Extra 2 seconds delay
        end
        
        if not autoATMEnabled then
            break
        end
    end
    
    -- After going through all ATMs, go straight to safe spot
    if autoATMEnabled then
        -- Teleport to safe spot and wait 10 seconds before restarting
        StatusLabel:Set("Status: All ATMs complete! Going to safe spot...")
        properTeleport(safeTeleportSpot)
        
        StatusLabel:Set("Status: Waiting 10 seconds before restart...")
        task.wait(10)
        
        StatusLabel:Set("Status: Restarting ATM run from ATM 1...")
    end
    
    end -- End of while loop
    
    disableFloat()
    disableAutoUnequip()
    completelyUnfreezeCharacter()
    StatusLabel:Set("Status: Autofarm Stopped")
    isRunning = false
end

-- Base location coordinate (spawn point)
local baseLocation = Vector3.new(-773, 25, -1283) -- Adjust this to your desired base location

-- Toggle
local AutoATMToggle = MainTab:CreateToggle({
   Name = "Autofarm [LOOK DOWN]",
   CurrentValue = false,
   Flag = "AutoATMToggle",
   Callback = function(Value)
       autoATMEnabled = Value
       
       if Value then
           StatusLabel:Set("Status: Autofarm Enabled with Auto Sell every 10 minutes!")
           task.spawn(runAutoATM)
       else
           StatusLabel:Set("Status: Autofarm Disabled - Stopping...")
           disableFloat()
           disableAutoUnequip()
           completelyUnfreezeCharacter()
           
           -- Teleport to base
           StatusLabel:Set("Status: Teleporting to base...")
           task.wait(0.5)
           properTeleport(baseLocation)
           
           StatusLabel:Set("Status: Autofarm Stopped - Returned to base")
       end
   end,
})

-- Manual Sell Button (from your original script)
local SellButton = MainTab:CreateButton({
   Name = "Manual Sell [35.000+]",
   Callback = function()
       StatusLabel:Set("Status: Manual sell - Teleporting to sell location...")
       
       -- Unfreeze character before teleporting
       completelyUnfreezeCharacter()
       
       -- Teleport to sell location
       properTeleport(sellLocation)
       StatusLabel:Set("Status: Teleported to sell location!")
   end,
})

Rayfield:LoadConfiguration()
